<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcards Anglais A1</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .app {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      width: 360px;
    }
    .card {
      border: 2px solid #333;
      border-radius: 12px;
      padding: 2rem;
      font-size: 1.8rem;
      cursor: pointer;
      margin-bottom: 1rem;
      min-height: 90px;
      display: flex;
      justify-content: center;
      align-items: center;
      white-space: pre-wrap;
      transition: background 0.3s;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    button {
      flex: 1;
      padding: 0.6rem;
      font-size: 0.9rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #333;
      color: white;
    }
    button:hover { opacity: 0.9; }
    select { margin-bottom: 1rem; padding: 0.5rem; width: 80%; font-size: 1rem; }
    #back-button { margin-top: 1rem; background: #555; }
    #error-msg { color: red; font-weight: bold; margin-bottom: 1rem; display: none; }
  </style>
</head>
<body>
  <div class="app">
    <h2>Flashcards A1 ðŸ‡¬ðŸ‡§</h2>
    <div id="login-section">
      <div id="error-msg">Code incorrect</div>
      <select id="username"></select>
      <input type="password" id="usercode" placeholder="Code profil" style="margin-bottom:1rem; padding:0.5rem; width:80%; font-size:1rem;" />
      <select id="wordlistSelect">
        <option value="19AhOg2DHrAzc6cO0C4sOr209cb-RAc8-foDQjzcFf-s">Liste 1</option>
        <option value="1SUjggWQCKXEkW26ERkwdk9EZ0Kslvnq38JJXHtp1etY">Liste 2</option>
      </select>
      <button onclick="login()">Commencer</button>
    </div>
    <div id="flashcard-section" style="display:none;">
      <div class="card" id="card">Clique pour commencer</div>
      <div class="buttons">
        <button onclick="rateCard('easy')">Facile</button>
        <button onclick="rateCard('medium')">Moyen</button>
        <button onclick="rateCard('hard')">Difficile</button>
      </div>
      <button id="back-button" onclick="backToLogin()">Retour au profil / liste</button>
    </div>
    <div style="margin-top:1rem; font-size:0.7rem; color:#888;">Â© 2026 Benjamin Boisteau</div>
  </div>
  <script>
    const profileSheetId = '1smkR9kDOJLGGIUO42heTyoc6wbdNCxT8yc4U4gNyxnk';
    const usernameSelect = document.getElementById('username');
    const usercodeInput = document.getElementById('usercode');
    const wordlistSelect = document.getElementById('wordlistSelect');
    const cardEl = document.getElementById('card');
    const loginSection = document.getElementById('login-section');
    const flashcardSection = document.getElementById('flashcard-section');
    const errorMsg = document.getElementById('error-msg');

    let profileCodes = {};

    async function loadProfiles() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${profileSheetId}/gviz/tq?sheet=Sheet1`;
        const res = await fetch(url);
        const text = await res.text();
        const jsonText = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/)[1];
        const data = JSON.parse(jsonText);
        const rows = data.table.rows;
        usernameSelect.innerHTML = '<option value="">Choisir un profil</option>';
        rows.forEach(row => {
          if (row.c[0] && row.c[1]) {
            const option = document.createElement('option');
            option.value = row.c[0].v;
            option.textContent = row.c[0].v;
            usernameSelect.appendChild(option);
            profileCodes[row.c[0].v] = row.c[1] ? String(row.c[1].v).trim() : '';
          }
        });
      } catch(err) {
        console.error(err);
        usernameSelect.innerHTML = '<option value="">Impossible de charger les profils</option>';
      }
    }

    let flashcards = [];

    async function loadFlashcards(sheetId) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=Sheet1`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonText = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/)[1];
      const data = JSON.parse(jsonText);
      flashcards = data.table.rows.map(row => ({
        en: row.c[0] ? row.c[0].v : '',
        fr: row.c[1] ? row.c[1].v : '',
        weight: 1
      }));
    }

    loadProfiles();
    loadFlashcards(wordlistSelect.value);
    wordlistSelect.addEventListener('change', () => loadFlashcards(wordlistSelect.value));

    let currentCard = null;
    let showEnglish = true;
    let username = null;

    function login() {
      const select = usernameSelect;
      const code = usercodeInput.value.trim();
      errorMsg.style.display = 'none';
      if (!select.value) return alert('Choisissez un profil');
      if (!profileCodes.hasOwnProperty(select.value)) {
        errorMsg.textContent = 'Profil inexistant';
        errorMsg.style.display = 'block';
        return;
      }
      if (profileCodes[select.value] !== code) {
        errorMsg.textContent = 'Code incorrect';
        errorMsg.style.display = 'block';
        return;
      }
      username = select.value;
      loginSection.style.display = 'none';
      flashcardSection.style.display = 'block';
      showNewCard();
    }

    function backToLogin() {
      flashcardSection.style.display = 'none';
      loginSection.style.display = 'block';
      usercodeInput.value = '';
      errorMsg.style.display = 'none';
    }

    function weightedRandomCard() {
      const totalWeight = flashcards.reduce((sum, c) => sum + c.weight, 0);
      let rand = Math.random() * totalWeight;
      for (let card of flashcards) {
        if (rand < card.weight) return card;
        rand -= card.weight;
      }
    }

    function showNewCard() {
      if (!flashcards.length) return;
      currentCard = weightedRandomCard();
      showEnglish = Math.random() < 0.5;
      cardEl.textContent = showEnglish ? currentCard.en : currentCard.fr;
      cardEl.style.background = showEnglish ? 'mistyrose' : 'lightblue';
      cardEl.style.color = showEnglish ? '#900' : '#006';
    }

    cardEl.addEventListener('click', () => {
      showEnglish = !showEnglish;
      cardEl.textContent = showEnglish ? currentCard.en : currentCard.fr;
      cardEl.style.background = showEnglish ? 'mistyrose' : 'lightblue';
      cardEl.style.color = showEnglish ? '#900' : '#006';
    });

    function rateCard(level) {
      if (!currentCard) return;
      if (level === 'easy') currentCard.weight = Math.max(1, currentCard.weight - 1);
      if (level === 'medium') currentCard.weight += 1;
      if (level === 'hard') currentCard.weight += 10;
      logCardToSheet(currentCard);
      showNewCard();
    }

    function logCardToSheet(card) {
      if (!card || !username) return;
      const payload = { word: card.en, profile: username, weight: card.weight };
      fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(err => console.error('Erreur log Google Sheet:', err));
    }
  </script>
</body>
</html>
